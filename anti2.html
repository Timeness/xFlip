<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Anti-Theft v2</title>
  <link href="https://fonts.googleapis.com/css2?family=Signika&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Signika', sans-serif;
      background-color: #000;
      color: #fff;
      padding: 1.5rem;
    }
    h1 {
      font-size: 1.6rem;
      color: #ffcc00;
      margin-bottom: 1rem;
    }
    .section {
      background: #111;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #333;
    }
    button {
      background: #ffcc00;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 10px;
    }
    .log {
      font-size: 0.9rem;
      color: #ccc;
      margin-top: 0.5rem;
    }
    #blackout {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #000;
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 1.5rem;
    }
  </style>
</head>
<body>

<h1>Anti-Theft Detection v2</h1>

<div class="section">
  <strong>Status:</strong> <span id="status">Disarmed</span><br>
  <button onclick="toggleSystem()">Arm / Disarm System</button>
</div>

<div class="section">
  <div><strong>Accelerometer:</strong> <span id="accel">Waiting...</span></div>
  <div><strong>Gyroscope:</strong> <span id="gyro">Waiting...</span></div>
</div>

<div class="section">
  <strong>Logs:</strong>
  <div id="logs" class="log">No activity yet.</div>
</div>

<audio id="alarm" src="https://freesound.org/data/previews/316/316847_4939433-lq.mp3"></audio>

<div id="blackout">Lockdown Triggered</div>

<script>
  let armed = false;
  let triggered = false;
  const motionThreshold = 8;
  const gyroThreshold = 6;
  const accelEl = document.getElementById("accel");
  const gyroEl = document.getElementById("gyro");
  const logs = document.getElementById("logs");
  const alarm = document.getElementById("alarm");
  const blackout = document.getElementById("blackout");

  function logEvent(msg) {
    const now = new Date();
    logs.innerHTML += `<br><strong>[${now.toLocaleTimeString()}]</strong> ${msg}`;
  }

  function triggerTrap(reason, val) {
    if (triggered || !armed) return;
    triggered = true;
    logEvent(`${reason} Triggered: ${val.toFixed(2)}`);
    alarm.play();
    navigator.vibrate([500, 300, 500]);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        logEvent(`Location: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
      });
    }

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          const video = document.createElement('video');
          video.srcObject = stream;
          video.play();
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          setTimeout(() => {
            context.drawImage(video, 0, 0, 320, 240);
            const dataURL = canvas.toDataURL();
            logEvent("Selfie Captured (base64):");
            console.log(dataURL);
            stream.getTracks().forEach(t => t.stop());
          }, 2000);
        });
    }

    blackout.style.display = 'flex';
    setTimeout(() => {
      blackout.style.display = 'none';
      triggered = false;
    }, 60000);
  }

  function toggleSystem() {
    armed = !armed;
    document.getElementById("status").textContent = armed ? "Armed" : "Disarmed";
    logEvent(armed ? "System Armed" : "System Disarmed");
  }

  try {
    const accel = new Accelerometer({ frequency: 60 });
    accel.addEventListener("reading", () => {
      const total = Math.sqrt(accel.x ** 2 + accel.y ** 2 + accel.z ** 2);
      accelEl.textContent = `X:${accel.x.toFixed(2)}, Y:${accel.y.toFixed(2)}, Z:${accel.z.toFixed(2)}`;
      if (total > motionThreshold) triggerTrap("Motion", total);
    });
    accel.start();
  } catch {
    accelEl.textContent = "Accelerometer not supported.";
  }

  try {
    const gyro = new Gyroscope({ frequency: 60 });
    gyro.addEventListener("reading", () => {
      const total = Math.sqrt(gyro.x ** 2 + gyro.y ** 2 + gyro.z ** 2);
      gyroEl.textContent = `X:${gyro.x.toFixed(2)}, Y:${gyro.y.toFixed(2)}, Z:${gyro.z.toFixed(2)}`;
      if (total > gyroThreshold) triggerTrap("Rotation", total);
    });
    gyro.start();
  } catch {
    gyroEl.textContent = "Gyroscope not supported.";
  }
</script>

</body>
</html>
