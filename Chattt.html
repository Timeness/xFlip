<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quosz - Ultimate Decentralized E2EE Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.39.0.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: #000; 
            color: #d1d5db; 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 16px; 
            animation: fadeIn 0.7s ease-out; 
            transition: background 0.5s ease; 
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%233b82f6" d="M2 2l16 16-6-6-4 4-6-6z"/></svg>'), auto; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(-30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes flip { from { transform: rotateY(90deg); } to { transform: rotateY(0); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px #3b82f6; } 50% { box-shadow: 0 0 15px #3b82f6; } }
        .container { max-width: 900px; width: 100%; }
        .form-container, .app-container { 
            background: rgba(17, 24, 39, 0.7); 
            backdrop-filter: blur(10px); 
            padding: 24px; 
            border-radius: 16px; 
            animation: slideUp 0.7s ease-out; 
        }
        .form-container { text-align: center; perspective: 1000px; }
        .form-inner { transition: transform 0.5s ease; transform-style: preserve-3d; }
        .form-inner.flip { transform: rotateY(180deg); }
        .logo { width: 40px; height: 40px; margin-bottom: 16px; animation: bounce 1s ease-out; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } }
        .form-field { position: relative; margin: 12px 0; }
        .form-field label { 
            position: absolute; 
            top: 10px; 
            left: 12px; 
            font-size: 12px; 
            color: #9ca3af; 
            transition: all 0.3s ease; 
            pointer-events: none; 
        }
        .form-field input:focus + label, .form-field input:not(:placeholder-shown) + label { 
            top: -8px; 
            font-size: 10px; 
            color: #3b82f6; 
        }
        input { 
            background: rgba(31, 41, 55, 0.7); 
            color: #d1d5db; 
            padding: 10px; 
            border-radius: 8px; 
            border: none; 
            width: 100%; 
            font-size: 14px; 
            outline: none; 
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; 
        }
        input:focus { background: rgba(55, 65, 81, 0.7); transform: scale(1.02); box-shadow: 0 0 10px #3b82f6; }
        button { 
            background: #3b82f6; 
            color: white; 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; 
        }
        button:hover { background: #2563eb; transform: scale(1.05); box-shadow: 0 0 15px #3b82f6; }
        button:active { transform: scale(0.95); }
        .error { color: #f87171; font-size: 12px; animation: shake 0.3s ease; }
        .success { color: #22c55e; font-size: 12px; }
        .photo-preview { width: 60px; height: 60px; border-radius: 50%; margin: 8px auto; display: none; }
        .password-meter { height: 4px; background: #374151; border-radius: 2px; margin-top: 4px; }
        .password-meter div { height: 100%; border-radius: 2px; transition: width 0.3s ease; }
        .weak { background: #f87171; width: 33%; }
        .medium { background: #facc15; width: 66%; }
        .strong { background: #22c55e; width: 100%; }
        .app-container { display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .search-bar { display: flex; gap: 8px; margin-bottom: 16px; position: relative; }
        .autocomplete { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: rgba(31, 41, 55, 0.7); 
            backdrop-filter: blur(10px); 
            border-radius: 8px; 
            max-height: 200px; 
            overflow-y: auto; 
            z-index: 10; 
        }
        .autocomplete div { padding: 8px; cursor: pointer; transition: background 0.3s ease; }
        .autocomplete div:hover { background: rgba(55, 65, 81, 0.7); }
        .user-list { list-style: none; }
        .user-list li { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 10px; 
            background: rgba(31, 41, 55, 0.7); 
            border-radius: 8px; 
            margin: 8px 0; 
            cursor: pointer; 
            transition: background 0.3s ease, transform 0.2s ease, opacity 0.3s ease; 
            animation: slideIn 0.3s ease-out forwards; 
        }
        .user-list li:hover { background: rgba(55, 65, 81, 0.7); transform: scale(1.02); box-shadow: 0 0 10px #3b82f6; }
        .user-list li.hidden { opacity: 0; height: 0; margin: 0; overflow: hidden; }
        .avatar { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            object-fit: cover; 
            transition: transform 0.3s ease; 
        }
        .avatar.active { animation: glow 1s infinite; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-left: 8px; }
        .online { background: #22c55e; }
        .away { background: #facc15; }
        .offline { background: #f87171; }
        .chat-box { 
            height: 400px; 
            background: rgba(17, 24, 39, 0.7); 
            backdrop-filter: blur(10px); 
            border-radius: 8px; 
            padding: 16px; 
            overflow-y: auto; 
            margin-bottom: 16px; 
            scroll-behavior: smooth; 
        }
        .message { 
            margin: 8px 0; 
            padding: 8px; 
            background: rgba(31, 41, 55, 0.7); 
            border-radius: 8px; 
            animation: slideIn 0.3s ease-out; 
            position: relative; 
        }
        .message:hover .message-actions { display: block; }
        .message-actions { 
            display: none; 
            position: absolute; 
            right: 8px; 
            top: -16px; 
            background: rgba(31, 41, 55, 0.7); 
            border-radius: 4px; 
            padding: 4px; 
        }
        .own { text-align: right; background: rgba(59, 130, 246, 0.2); }
        .read { color: #60a5fa; }
        .typing { font-style: italic; color: #6b7280; }
        .typing span { display: inline-block; animation: pulse 0.5s infinite alternate; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        .chat-input { display: flex; gap: 8px; }
        .chat-input input { flex: 1; }
        .emoji-picker { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .emoji-picker span { cursor: pointer; font-size: 18px; transition: transform 0.2s ease; }
        .emoji-picker span:hover { transform: scale(1.2); }
        .status { color: #9ca3af; font-size: 12px; margin-top: 8px; transition: opacity 0.3s ease; }
        .spinner { 
            border: 2px solid #3b82f6; 
            border-top: 2px solid transparent; 
            border-radius: 50%; 
            width: 16px; 
            height: 16px; 
            animation: spin 1s linear infinite; 
            display: inline-block; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .profile-card { 
            position: absolute; 
            background: rgba(31, 41, 55, 0.9); 
            backdrop-filter: blur(10px); 
            border-radius: 8px; 
            padding: 8px; 
            z-index: 10; 
            display: none; 
        }
        canvas { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="form" class="form-container">
            <svg class="logo" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 5L30 15V35H10V15L20 5Z" fill="#3b82f6"/>
                <circle cx="20" cy="20" r="8" fill="#fff"/>
                <path d="M20 16V24M16 20H24" stroke="#3b82f6" stroke-width="2"/>
            </svg>
            <div class="form-inner">
                <div id="register-form">
                    <p class="mb-4 text-sm">Create Quosz Account</p>
                    <div class="form-field">
                        <input type="text" id="reg-username" placeholder=" " aria-label="Username">
                        <label>Username (min 3 chars)</label>
                    </div>
                    <div class="form-field">
                        <input type="email" id="reg-email" placeholder=" " aria-label="Email">
                        <label>Email (optional)</label>
                    </div>
                    <div class="form-field">
                        <input type="password" id="reg-password" placeholder=" " aria-label="Password">
                        <label>Password</label>
                        <div id="password-meter" class="password-meter"><div></div></div>
                    </div>
                    <div class="form-field">
                        <input type="text" id="reg-recovery" placeholder=" " aria-label="Recovery question">
                        <label>Recovery question (e.g., Pet's name)</label>
                    </div>
                    <div class="form-field">
                        <input type="file" id="photo" accept="image/*" aria-label="Profile photo">
                        <label>Profile Photo</label>
                        <img id="photo-preview" class="photo-preview" src="">
                    </div>
                    <button onclick="createAccount()">Register</button>
                    <p class="form-toggle text-sm">Have an account? <a href="#" onclick="showLogin()">Login</a></p>
                </div>
                <div id="login-form" style="display: none;">
                    <p class="mb-4 text-sm">Login to Quosz</p>
                    <div class="form-field">
                        <input type="text" id="login-username" placeholder=" " aria-label="Username">
                        <label>Username</label>
                    </div>
                    <div class="form-field">
                        <input type="password" id="login-password" placeholder=" " aria-label="Password">
                        <label>Password</label>
                    </div>
                    <button onclick="login()">Login</button>
                    <p class="form-toggle text-sm">Need an account? <a href="#" onclick="showRegister()">Register</a></p>
                    <p class="form-toggle text-sm"><a href="#" onclick="recoverAccount()">Forgot Password?</a></p>
                </div>
            </div>
            <p id="error" class="error"></p>
            <p id="success" class="success"></p>
        </div>
        <div id="app" class="app-container">
            <div class="header">
                <div class="flex items-center gap-4">
                    <svg class="logo" style="width: 24px; height: 24px;" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 5L30 15V35H10V15L20 5Z" fill="#3b82f6"/>
                        <circle cx="20" cy="20" r="8" fill="#fff"/>
                        <path d="M20 16V24M16 20H24" stroke="#3b82f6" stroke-width="2"/>
                    </svg>
                    <img id="userAvatar" class="avatar" src="https://via.placeholder.com/36" alt="User avatar">
                    <h2 id="userInfo" class="font-medium text-sm"></h2>
                </div>
                <div>
                    <button onclick="toggleTheme()" class="text-sm">🌙</button>
                    <button onclick="editProfile()" class="text-sm ml-2">✏️</button>
                    <button onclick="logout()" class="text-sm ml-2">🚪</button>
                    <button onclick="exportChats()" class="text-sm ml-2">📤</button>
                    <button onclick="importChats()" class="text-sm ml-2">📥</button>
                </div>
            </div>
            <div class="search-bar">
                <input type="text" id="search" placeholder="Search users..." onkeyup="searchUsers()" aria-label="Search users">
                <div id="autocomplete" class="autocomplete"></div>
            </div>
            <ul id="users" class="user-list"></ul>
            <div id="chat" class="chat-box"></div>
            <div class="chat-input">
                <input type="text" id="message" placeholder="Type a message..." onkeypress="handleKeyPress(event)" aria-label="Chat message">
                <button onclick="sendMessage()">Send</button>
            </div>
            <div class="emoji-picker">
                <span onclick="addEmoji('😊')">😊</span>
                <span onclick="addEmoji('👍')">👍</span>
                <span onclick="addEmoji('❤️')">❤️</span>
                <span onclick="addEmoji('😂')">😂</span>
                <input type="text" id="emoji-search" placeholder="Search emoji..." onkeyup="filterEmojis()" class="text-sm">
            </div>
            <div class="status">Status: <span id="status-text"></span></div>
            <canvas id="qr-code" width="100" height="100" style="display: none;"></canvas>
        </div>
    </div>

    <script>
        // Global vars
        let currentUser = { username: '', id: '', photo: '', email: '', recovery: '', alias: '', status: 'Available' };
        let pubnub, localPeer, dataChannel, connectedPeer = null;
        let onlineUsers = {};
        let chatHistory = JSON.parse(localStorage.getItem('quoszChats') || '{}');
        let typingTimer, sessionTimer;
        let isDark = true;
        let offlineQueue = [];
        const emojis = ['😊', '👍', '❤️', '😂', '😎', '😢', '🎉'];

        // QR Code (mock)
        function generateQR(text) {
            const canvas = document.getElementById('qr-code');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < 25; i++) for (let j = 0; j < 25; j++)
                if (Math.random() > 0.5) ctx.fillRect(i * 4, j * 4, 4, 4);
            alert('QR Code for ID: ' + text);
        }

        // Photo crop
        function previewPhoto(file, callback) {
            const canvas = document.getElementById('qr-code'); // Reuse canvas
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0, 100, 100);
                document.getElementById('photo-preview').src = canvas.toDataURL();
                document.getElementById('photo-preview').style.display = 'block';
                callback(canvas.toDataURL());
            };
            img.src = URL.createObjectURL(file);
        }

        // Password hash
        async function hashPassword(password) {
            const enc = new TextEncoder();
            const hash = await crypto.subtle.digest('SHA-256', enc.encode(password));
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Password strength
        function checkPasswordStrength(password) {
            const meter = document.getElementById('password-meter').firstChild;
            if (password.length < 6) meter.className = 'weak';
            else if (password.length < 10) meter.className = 'medium';
            else meter.className = 'strong';
        }

        // UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        // Avatar generator
        function generateAvatar(username) {
            return `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect width='100%' height='100%' fill='%233b82f6'/><text x='50%' y='50%' font-family='Poppins' font-size='18' fill='white' text-anchor='middle' dy='.3em'>${username[0].toUpperCase()}</text></svg>`;
        }

        // Account management
        async function createAccount() {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const recovery = document.getElementById('reg-recovery').value.trim();
            const photoInput = document.getElementById('photo');
            const error = document.getElementById('error');
            const success = document.getElementById('success');

            if (username.length < 3) return error.textContent = 'Username must be 3+ characters';
            const existingUsers = JSON.parse(localStorage.getItem('quoszUsers') || '[]');
            if (existingUsers.includes(username)) return error.textContent = 'Username taken';
            if (!password) return error.textContent = 'Password required';
            if (!recovery) return error.textContent = 'Recovery question required';

            let photo = generateAvatar(username);
            if (photoInput.files[0]) {
                photo = await new Promise(resolve => previewPhoto(photoInput.files[0], resolve));
            }

            currentUser = {
                username,
                id: generateUUID(),
                photo,
                email,
                recovery,
                password: await hashPassword(password),
                alias: username,
                status: 'Available',
                lastSeen: Date.now(),
                verified: Math.random() > 0.8 // Mock verification
            };
            localStorage.setItem('quoszUser', JSON.stringify(currentUser));
            localStorage.setItem('quoszUsers', JSON.stringify([...existingUsers, username]));
            localStorage.setItem('quoszActivity', JSON.stringify([...JSON.parse(localStorage.getItem('quoszActivity') || '[]'), { action: 'register', time: Date.now() }]));
            success.textContent = 'Account created!';
            setTimeout(startApp, 1000);
        }

        async function login() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const error = document.getElementById('error');
            const user = JSON.parse(localStorage.getItem('quoszUser') || '{}');

            if (user.username !== username || user.password !== await hashPassword(password)) {
                error.textContent = 'Invalid credentials';
                return;
            }
            currentUser = user;
            localStorage.setItem('quoszActivity', JSON.stringify([...JSON.parse(localStorage.getItem('quoszActivity') || '[]'), { action: 'login', time: Date.now() }]));
            startApp();
        }

        function recoverAccount() {
            const recovery = prompt('Enter your recovery answer:');
            const user = JSON.parse(localStorage.getItem('quoszUser') || '{}');
            if (user.recovery === recovery) alert('Password: ' + user.password); // Mock recovery
            else document.getElementById('error').textContent = 'Invalid recovery answer';
        }

        function showLogin() {
            document.getElementById('form-inner').classList.add('flip');
            setTimeout(() => {
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('form-inner').classList.remove('flip');
            }, 250);
        }

        function showRegister() {
            document.getElementById('form-inner').classList.add('flip');
            setTimeout(() => {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
                document.getElementById('form-inner').classList.remove('flip');
            }, 250);
        }

        function startApp() {
            document.getElementById('form').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userInfo').textContent = `${currentUser.alias} (${currentUser.id}) ${currentUser.verified ? '✅' : ''}`;
            if (currentUser.photo) document.getElementById('userAvatar').src = currentUser.photo;
            generateQR(currentUser.id);
            initSignaling();
            updateStatus('Online. Search for users to chat.');
            loadChatHistory();
            sessionTimer = setTimeout(logout, 30 * 60 * 1000);
            document.getElementById('reg-password').oninput = (e) => checkPasswordStrength(e.target.value);
        }

        function editProfile() {
            document.getElementById('app').style.display = 'none';
            document.getElementById('form').style.display = 'block';
            document.getElementById('register-form').style.display = 'block';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('reg-username').value = currentUser.username;
            document.getElementById('reg-email').value = currentUser.email;
            document.getElementById('reg-recovery').value = currentUser.recovery;
            if (currentUser.photo) document.getElementById('photo-preview').src = currentUser.photo;
        }

        function logout() {
            currentUser.lastSeen = Date.now();
            localStorage.setItem('quoszUser', JSON.stringify(currentUser));
            document.getElementById('app').style.display = 'none';
            document.getElementById('form').style.display = 'block';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
            pubnub?.unsubscribeAll();
            clearTimeout(sessionTimer);
        }

        function toggleTheme() {
            isDark = !isDark;
            document.body.style.background = isDark ? '#000' : 'linear-gradient(135deg, #111827, #1e293b)';
            localStorage.setItem('quoszTheme', isDark ? 'dark' : 'gradient');
        }

        // Signaling
        function initSignaling() {
            pubnub = new PubNub({
                publishKey: 'demo',
                subscribeKey: 'demo',
                channel: 'quosz_signal'
            });
            pubnub.addListener({ message: m => handleSignal(m.message) });
            pubnub.subscribe({ channels: ['quosz_signal'] });

            setInterval(() => {
                currentUser.lastSeen = Date.now();
                pubnub.publish({
                    channel: 'quosz_signal',
                    message: { type: 'online', user: currentUser, socketId: Date.now() }
                });
                updateOnlineUsers();
            }, 5000);
        }

        function updateOnlineUsers() {
            const usersList = document.getElementById('users');
            usersList.innerHTML = '';
            const blocked = JSON.parse(localStorage.getItem('quoszBlocked') || '[]');
            Object.values(onlineUsers).forEach((user, index) => {
                if (user.username !== currentUser.username && !blocked.includes(user.username)) {
                    const li = document.createElement('li');
                    li.style.animationDelay = `${index * 0.05}s`;
                    const timeDiff = (Date.now() - user.lastSeen) / 1000 / 60;
                    const status = timeDiff < 1 ? 'online' : timeDiff < 5 ? 'away' : 'offline';
                    li.innerHTML = `
                        <img src="${user.photo || generateAvatar(user.username)}" class="avatar ${status === 'online' ? 'active' : ''}">
                        ${user.alias || user.username} ${user.verified ? '✅' : ''}
                        <span class="status-dot ${status}"></span>
                        <small>${timeDiff < 1 ? 'Now' : timeDiff < 60 ? Math.floor(timeDiff) + 'm ago' : new Date(user.lastSeen).toLocaleTimeString()}</small>
                    `;
                    li.onclick = () => startChat(user);
                    li.oncontextmenu = (e) => { e.preventDefault(); blockUser(user.username); };
                    li.onmouseenter = () => showProfileCard(user, li);
                    li.onmouseleave = () => document.querySelector('.profile-card')?.remove();
                    usersList.appendChild(li);
                }
            });
        }

        function showProfileCard(user, li) {
            const card = document.createElement('div');
            card.className = 'profile-card';
            card.style.top = `${li.offsetTop + 40}px`;
            card.style.left = `${li.offsetLeft}px`;
            card.innerHTML = `
                <p><strong>${user.alias || user.username}</strong> ${user.verified ? '✅' : ''}</p>
                <p>ID: ${user.id}</p>
                <p>Email: ${user.email || 'N/A'}</p>
                <p>Status: ${user.status}</p>
            `;
            document.querySelector('.container').appendChild(card);
            setTimeout(() => card.style.display = 'block', 10);
        }

        function blockUser(username) {
            const blocked = JSON.parse(localStorage.getItem('quoszBlocked') || '[]');
            localStorage.setItem('quoszBlocked', JSON.stringify([...blocked, username]));
            updateOnlineUsers();
        }

        function searchUsers() {
            const query = document.getElementById('search').value.toLowerCase();
            const autocomplete = document.getElementById('autocomplete');
            autocomplete.innerHTML = '';
            if (query) {
                Object.values(onlineUsers).forEach(user => {
                    if (user.username.toLowerCase().includes(query) && user.username !== currentUser.username) {
                        const div = document.createElement('div');
                        div.textContent = user.username;
                        div.onclick = () => { document.getElementById('search').value = user.username; startChat(user); };
                        autocomplete.appendChild(div);
                    }
                });
                localStorage.setItem('quoszSearchHistory', JSON.stringify([...JSON.parse(localStorage.getItem('quoszSearchHistory') || '[]'), query].slice(-5)));
            }
            document.querySelectorAll('.user-list li').forEach(li => {
                li.classList.toggle('hidden', !li.textContent.toLowerCase().includes(query));
            });
        }

        function filterEmojis() {
            const query = document.getElementById('emoji-search').value.toLowerCase();
            document.querySelectorAll('.emoji-picker span').forEach(span => {
                span.style.display = emojis.includes(span.textContent) && span.textContent.includes(query) ? 'inline' : 'none';
            });
        }

        // WebRTC
        function startChat(targetUser) {
            connectedPeer = targetUser;
            updateStatus(`Connecting to ${targetUser.username}... <span class="spinner"></span>`);
            createPeerConnection();
            pubnub.publish({
                channel: 'quosz_signal',
                message: { type: 'offer', from: currentUser, to: targetUser, offer: localPeer.localDescription }
            });
            if (offlineQueue.length) {
                offlineQueue.forEach(msg => dataChannel?.send(msg));
                offlineQueue = [];
            }
        }

        function createPeerConnection(retryCount = 0) {
            localPeer = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            localPeer.onicecandidate = e => {
                if (e.candidate) {
                    pubnub.publish({
                        channel: 'quosz_signal',
                        message: { type: 'ice', from: currentUser, to: connectedPeer, candidate: e.candidate }
                    });
                }
            };
            dataChannel = localPeer.createDataChannel('chat');
            setupDataChannel();
            localPeer.createOffer().then(offer => localPeer.setLocalDescription(offer));
            if (retryCount < 3) {
                setTimeout(() => {
                    if (dataChannel.readyState !== 'open') createPeerConnection(retryCount + 1);
                }, 5000 * (retryCount + 1));
            } else {
                updateStatus('Connection failed. Try again.');
            }
        }

        function setupDataChannel() {
            dataChannel.onopen = () => {
                updateStatus(`Connected to ${connectedPeer.username} 🔒 <span class="status-dot online"></span>`);
                sendReadReceipts();
            };
            dataChannel.onmessage = async e => {
                const decrypted = await decryptMessage(e.data);
                if (decrypted === 'read') markMessagesRead();
                else if (decrypted === 'reaction') addReaction(e.data.meta);
                else if (decrypted !== '...') {
                    addMessage(decrypted, false);
                    playNotification();
                    navigator.vibrate?.([200, 100, 200]);
                    saveChatHistory(decrypted, false);
                    dataChannel.send(await encryptMessage('read'));
                } else showTyping(false);
            };
            dataChannel.onclose = () => updateStatus('Connection closed.');
        }

        function handleSignal(msg) {
            if (msg.to?.username !== currentUser.username) return;
            if (msg.type === 'offer') {
                createPeerConnection();
                localPeer.setRemoteDescription(new RTCSessionDescription(msg.offer));
                localPeer.createAnswer().then(answer => {
                    localPeer.setLocalDescription(answer);
                    pubnub.publish({
                        channel: 'quosz_signal',
                        message: { type: 'answer', from: currentUser, to: msg.from, answer }
                    });
                });
            } else if (msg.type === 'answer') {
                localPeer.setRemoteDescription(new RTCSessionDescription(msg.answer));
            } else if (msg.type === 'ice') {
                localPeer.addIceCandidate(new RTCIceCandidate(msg.candidate));
            } else if (msg.type === 'online') {
                onlineUsers[msg.socketId] = msg.user;
                updateOnlineUsers();
            }
        }

        // E2EE
        async function deriveKey() {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw', enc.encode(currentUser.username + connectedPeer.username),
                { name: 'PBKDF2' }, false, ['deriveBits']
            );
            return crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: enc.encode('quosz_salt'), iterations: 100000, hash: 'SHA-256' },
                keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
            );
        }

        async function encryptMessage(msg, meta = null) {
            const key = await deriveKey();
            const enc = new TextEncoder();
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(msg));
            return { data: btoa(String.fromCharCode(...new Uint8Array([...iv, ...new Uint8Array(encrypted)]))), meta };
        }

        async function decryptMessage({ data, meta }) {
            const key = await deriveKey();
            const decoded = Uint8Array.from(atob(data), c => c.charCodeAt(0));
            const iv = decoded.slice(0, 12);
            const encrypted = decoded.slice(12);
            const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encrypted);
            return { text: new TextDecoder().decode(decrypted), meta };
        }

        // Chat UI
        async function sendMessage() {
            const msg = document.getElementById('message').value.trim();
            if (!msg || !dataChannel || dataChannel.readyState !== 'open') {
                if (msg) offlineQueue.push(await encryptMessage(msg));
                return;
            }
            const formatted = formatMessage(msg);
            const encrypted = await encryptMessage(formatted);
            dataChannel.send(encrypted.data);
            addMessage(formatted, true);
            saveChatHistory(formatted, true);
            document.getElementById('message').value = '';
            navigator.vibrate?.([100, 50, 100]);
            playNotification();
        }

        function handleKeyPress(e) {
            if (e.ctrlKey && e.key === 'Enter') sendMessage();
            if (e.key === 'Escape') document.getElementById('message').value = '';
            clearTimeout(typingTimer);
            dataChannel?.send((await encryptMessage('...')).data);
            typingTimer = setTimeout(() => showTyping(true), 1000);
            const input = document.getElementById('message');
            if (input.value.match(/:[a-z]+:/)) {
                const emoji = emojis.find(e => input.value.includes(`:${e}:`));
                if (emoji) input.value = input.value.replace(/:[a-z]+:/, emoji);
            }
            localStorage.setItem('quoszDraft', input.value);
        }

        function formatMessage(msg) {
            return msg.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>');
        }

        function addEmoji(emoji) {
            const input = document.getElementById('message');
            input.value += emoji;
            input.focus();
        }

        function showTyping(hide) {
            const chat = document.getElementById('chat');
            let typingEl = chat.querySelector('.typing');
            if (hide) {
                if (typingEl) typingEl.remove();
                return;
            }
            if (!typingEl) {
                typingEl = document.createElement('div');
                typingEl.className = 'message typing';
                typingEl.innerHTML = `${connectedPeer?.username || ''} is typing <span>.</span><span>.</span><span>.</span>`;
                chat.appendChild(typingEl);
                chat.scrollTop = chat.scrollHeight;
            }
        }

        function addMessage(msg, isOwn, time = Date.now()) {
            const chat = document.getElementById('chat');
            if (chat.querySelector('.typing')) chat.querySelector('.typing').remove();
            const div = document.createElement('div');
            div.className = `message ${isOwn ? 'own' : ''}`;
            div.innerHTML = `
                ${isOwn ? '' : connectedPeer.username + ': '}
                ${msg}
                <small title="${new Date(time).toLocaleString()}">${new Date(time).toLocaleTimeString()}</small>
                <div class="message-actions">
                    <button onclick="copyMessage(this)" class="text-xs">Copy</button>
                    ${isOwn ? `<button onclick="editMessage(this)" class="text-xs">Edit</button><button onclick="deleteMessage(this)" class="text-xs">Delete</button>` : ''}
                    <button onclick="reactMessage(this, '👍')" class="text-xs">👍</button>
                    <button onclick="reactMessage(this, '❤️')" class="text-xs">❤️</button>
                </div>
            `;
            chat.appendChild(div);
            if (!chat.dataset.scrollLocked) chat.scrollTop = chat.scrollHeight;
        }

        function copyMessage(btn) {
            const text = btn.parentElement.parentElement.childNodes[1].textContent;
            navigator.clipboard.writeText(text);
            updateStatus('Message copied');
        }

        function editMessage(btn) {
            const msgEl = btn.parentElement.parentElement;
            const text = msgEl.childNodes[1].textContent;
            const newText = prompt('Edit message:', text);
            if (newText && Date.now() - new Date(msgEl.querySelector('small').title).getTime() < 5 * 60 * 1000) {
                msgEl.childNodes[1].textContent = formatMessage(newText);
                saveChatHistory(null, null, true);
                saveChatHistory(newText, true);
            }
        }

        function deleteMessage(btn) {
            btn.parentElement.parentElement.remove();
            saveChatHistory(null, null, true);
        }

        function reactMessage(btn, emoji) {
            const msgEl = btn.parentElement.parentElement;
            msgEl.innerHTML += ` <span>${emoji}</span>`;
            dataChannel?.send((await encryptMessage('reaction', { emoji, id: msgEl.dataset.id })).data);
        }

        function addReaction({ emoji, id }) {
            const msgEl = document.querySelector(`.message[data-id="${id}"]`);
            if (msgEl) msgEl.innerHTML += ` <span>${emoji}</span>`;
        }

        function saveChatHistory(msg, isOwn, clear = false) {
            if (!connectedPeer) return;
            if (!chatHistory[connectedPeer.username]) chatHistory[connectedPeer.username] = [];
            if (clear) chatHistory[connectedPeer.username] = [];
            else if (msg) chatHistory[connectedPeer.username].push({ msg, isOwn, time: Date.now(), id: generateUUID() });
            localStorage.setItem('quoszChats', JSON.stringify(chatHistory));
            setTimeout(() => localStorage.setItem('quoszChatsBackup', JSON.stringify(chatHistory)), 5 * 60 * 1000);
        }

        function loadChatHistory() {
            if (!connectedPeer) return;
            const chat = document.getElementById('chat');
            chat.innerHTML = '';
            (chatHistory[connectedPeer.username] || []).forEach(({ msg, isOwn, time, id }) => {
                const div = document.createElement('div');
                div.dataset.id = id;
                addMessage(msg, isOwn, time);
            });
        }

        function markMessagesRead() {
            document.querySelectorAll('.message.own').forEach(msg => msg.classList.add('read'));
        }

        function sendReadReceipts() {
            dataChannel?.send((await encryptMessage('read')).data);
        }

        function exportChats() {
            const data = JSON.stringify(chatHistory);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quosz_chats.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importChats() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    chatHistory = JSON.parse(reader.result);
                    localStorage.setItem('quoszChats', JSON.stringify(chatHistory));
                    loadChatHistory();
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function playNotification() {
            new Audio('data:audio/mp3;base64,//MkxAA...').play().catch(() => {}); // Replace with real sound
        }

        function updateStatus(text) {
            const status = document.getElementById('status-text');
            status.style.opacity = 0;
            setTimeout(() => {
                status.innerHTML = text;
                status.style.opacity = 1;
            }, 300);
        }

        // Auto-login
        if (localStorage.getItem('quoszUser')) {
            currentUser = JSON.parse(localStorage.getItem('quoszUser'));
            startApp();
        }
        if (localStorage.getItem('quoszTheme') !== 'dark') toggleTheme();
        document.getElementById('message').value = localStorage.getItem('quoszDraft') || '';
    </script>
</body>
</html>
