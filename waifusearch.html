<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WaifuVerse Character Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #000000;
      color: #ffffff;
      min-height: 100vh;
    }
    /* Remove button border and background */
    button {
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.125rem;
      color: #60a5fa; /* Tailwind blue-400 */
      transition: color 0.3s ease;
    }
    button:hover {
      color: #3b82f6; /* Tailwind blue-500 */
    }
    /* Hide scrollbar for image container if needed */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body>
  <div id="app" class="flex flex-col min-h-screen">
    <main class="flex-grow flex flex-col justify-center items-center px-4 py-8 max-w-4xl mx-auto w-full">
      <div id="content" class="w-full max-w-3xl">
        <!-- Content will be injected here -->
      </div>
    </main>
  </div>

  <script>
    const API_BASE = "https://yash.mirza.ink";
    const AUTH_PASS = "WaifuVerse:0000&admin";

    // Utility: escape HTML to prevent XSS
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Get query param ?s=character_id
    function getCharacterIdFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get("s");
    }

    // Create element with classes and text
    function createEl(tag, classes = "", text = "") {
      const el = document.createElement(tag);
      if (classes) el.className = classes;
      if (text) el.textContent = text;
      return el;
    }

    // Create icon span for grade icon
    function createGradeIcon(icon) {
      const span = createEl("span", "text-2xl mr-2");
      span.textContent = icon;
      return span;
    }

    // Fetch character details by character_id
    async function fetchCharacterDetails(characterId) {
      try {
        const url = new URL(API_BASE + "/search_character_from_anime");
        url.searchParams.append("character_id", characterId);
        const res = await fetch(url.toString(), {
          headers: { Authorization: AUTH_PASS },
        });
        if (!res.ok) {
          throw new Error(`API error: ${res.status}`);
        }
        const data = await res.json();
        if (!data.characters || data.characters.length === 0) {
          return null;
        }
        // Return first matched character
        return data.characters[0];
      } catch (e) {
        console.error("Fetch error:", e);
        return null;
      }
    }

    // Fetch anime details by anime_id
    async function fetchAnimeById(animeId) {
      try {
        const url = new URL(API_BASE + "/get_anime_by_id");
        url.searchParams.append("anime_id", animeId);
        const res = await fetch(url.toString(), {
          headers: { Authorization: AUTH_PASS },
        });
        if (!res.ok) {
          throw new Error(`API error: ${res.status}`);
        }
        const data = await res.json();
        return data.anime || null;
      } catch (e) {
        console.error("Fetch anime error:", e);
        return null;
      }
    }

    // Fetch how many users own this character (globally owned count)
    async function fetchGlobalOwnershipCount(characterId) {
      try {
        const url = new URL(API_BASE + "/get_all_users");
        const res = await fetch(url.toString(), {
          headers: { Authorization: AUTH_PASS },
        });
        if (!res.ok) {
          throw new Error(`API error: ${res.status}`);
        }
        const data = await res.json();
        if (!data.users) return 0;
        let count = 0;
        for (const user of data.users) {
          if (user.characters && user.characters.some(c => c.id === characterId)) {
            count++;
          }
        }
        return count;
      } catch (e) {
        console.error("Fetch ownership count error:", e);
        return 0;
      }
    }

    // Render the character details UI
    async function renderCharacterDetails(characterId) {
      const container = document.getElementById("content");
      container.innerHTML = "";

      // Show loading spinner
      const loading = createEl("div", "flex justify-center items-center py-20");
      loading.innerHTML = `
        <svg class="animate-spin h-10 w-10 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
        </svg>
      `;
      container.appendChild(loading);

      const character = await fetchCharacterDetails(characterId);
      if (!character) {
        container.innerHTML = `<p class="text-center text-gray-400 text-lg mt-20">Character not found.</p>`;
        return;
      }

      const anime = await fetchAnimeById(character.anime_id);
      const ownedCount = await fetchGlobalOwnershipCount(characterId);

      container.innerHTML = "";

      // Image
      const imgWrapper = createEl("div", "w-full max-w-md mx-auto rounded-lg overflow-hidden shadow-lg mb-8");
      const img = createEl("img", "w-full object-cover");
      img.src = character.img_url || "https://placehold.co/600x800?text=No+Image";
      img.alt = `Image of character ${character.character_name} from anime ${anime ? anime.anime_name : "Unknown"}`;
      imgWrapper.appendChild(img);
      container.appendChild(imgWrapper);

      // Details container
      const details = createEl("div", "text-center space-y-4");

      // Character Name with Grade Icon
      const gradeIcon = character.grade?.icon || "";
      const charNameEl = createEl("h1", "text-4xl font-semibold flex justify-center items-center justify-center");
      if (gradeIcon) {
        const iconSpan = createGradeIcon(gradeIcon);
        charNameEl.appendChild(iconSpan);
      }
      charNameEl.appendChild(document.createTextNode(character.character_name));
      details.appendChild(charNameEl);

      // Character ID
      const charIdEl = createEl("p", "text-gray-400 text-sm");
      charIdEl.textContent = `Character ID: ${character.id}`;
      details.appendChild(charIdEl);

      // Anime Name and ID
      const animeNameEl = createEl("p", "text-lg font-medium");
      animeNameEl.innerHTML = `Anime Name: <span class="font-semibold">${anime ? escapeHtml(anime.anime_name) : "Unknown"}</span>`;
      details.appendChild(animeNameEl);

      const animeIdEl = createEl("p", "text-gray-400 text-sm");
      animeIdEl.textContent = `Anime ID: ${character.anime_id}`;
      details.appendChild(animeIdEl);

      // Grade
      const gradeEl = createEl("p", "text-lg");
      gradeEl.innerHTML = `Grade: <span class="font-semibold">${character.grade?.type || "Unknown"}</span>`;
      details.appendChild(gradeEl);

      // Role(s)
      const roleEl = createEl("p", "text-lg");
      roleEl.innerHTML = `Role: <span class="font-semibold">${character.role || "Unknown"}</span>`;
      details.appendChild(roleEl);

      // Globally owned count
      const ownedEl = createEl("p", "text-gray-400 text-sm");
      ownedEl.textContent = `Globally owned by ${ownedCount} user${ownedCount !== 1 ? "s" : ""}`;
      details.appendChild(ownedEl);

      container.appendChild(details);

      // Buy button (no border, no background)
      const btnWrapper = createEl("div", "mt-10 flex justify-center");
      const buyBtn = createEl("button", "focus:outline-none");
      buyBtn.textContent = "Buy";
      buyBtn.setAttribute("aria-label", "Buy this character");
      buyBtn.addEventListener("click", () => {
        alert(`You clicked Buy for ${character.character_name}`);
      });
      btnWrapper.appendChild(buyBtn);
      container.appendChild(btnWrapper);
    }

    // On load
    (function () {
      const characterId = getCharacterIdFromQuery();
      if (!characterId) {
        // Show only black page with no content
        document.getElementById("content").innerHTML = "";
        return;
      }
      renderCharacterDetails(characterId);
    })();
  </script>
</body>
</html>
